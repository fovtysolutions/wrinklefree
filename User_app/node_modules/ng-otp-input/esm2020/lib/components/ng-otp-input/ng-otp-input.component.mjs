import { Component, Input, Output, EventEmitter } from '@angular/core';
import { FormGroup, FormControl } from '@angular/forms';
import { KeyboardUtil } from '../../utils/keyboard-util';
import * as i0 from "@angular/core";
import * as i1 from "../../pipes/keys.pipe";
import * as i2 from "@angular/common";
import * as i3 from "@angular/forms";
export class NgOtpInputComponent {
    constructor(keysPipe) {
        this.keysPipe = keysPipe;
        this.config = { length: 4 };
        // tslint:disable-next-line: no-output-on-prefix
        this.onInputChange = new EventEmitter();
        this.inputControls = new Array(this.config.length);
        this.componentKey = Math.random()
            .toString(36)
            .substring(2) + new Date().getTime().toString(36);
    }
    get inputType() {
        return this.config?.isPasswordInput
            ? 'password'
            : this.config?.allowNumbersOnly
                ? 'tel'
                : 'text';
    }
    ngOnInit() {
        this.otpForm = new FormGroup({});
        for (let index = 0; index < this.config.length; index++) {
            this.otpForm.addControl(this.getControlName(index), new FormControl());
        }
        this.otpForm.valueChanges.subscribe((v) => {
            this.keysPipe.transform(this.otpForm.controls).forEach((k) => {
                var val = this.otpForm.controls[k].value;
                if (val && val.length > 1) {
                    if (val.length >= this.config.length) {
                        this.setValue(val);
                    }
                    else {
                        this.rebuildValue();
                    }
                }
            });
        });
    }
    ngAfterViewInit() {
        if (!this.config.disableAutoFocus) {
            const containerItem = document.getElementById(`c_${this.componentKey}`);
            if (containerItem) {
                const ele = containerItem.getElementsByClassName('otp-input')[0];
                if (ele && ele.focus) {
                    ele.focus();
                }
            }
        }
    }
    getControlName(idx) {
        return `ctrl_${idx}`;
    }
    onKeyDown($event, inputIdx) {
        const prevInputId = this.getBoxId(inputIdx - 1);
        const currentInputId = this.getBoxId(inputIdx);
        if (KeyboardUtil.ifSpacebar($event)) {
            $event.preventDefault();
            return false;
        }
        if (KeyboardUtil.ifBackspace($event)) {
            if (!$event.target.value) {
                this.clearInput(prevInputId, inputIdx - 1);
                this.setSelected(prevInputId);
            }
            else {
                this.clearInput(currentInputId, inputIdx);
            }
            this.rebuildValue();
            return;
        }
    }
    onInput($event) {
        let newVal = this.currentVal ? `${this.currentVal}${$event.target.value}` : $event.target.value;
        if (this.config.allowNumbersOnly && !this.validateNumber(newVal)) {
            $event.target.value = '';
            $event.stopPropagation();
            $event.preventDefault();
            return;
        }
    }
    onKeyUp($event, inputIdx) {
        if (KeyboardUtil.ifTab($event)) {
            inputIdx -= 1;
        }
        const nextInputId = this.getBoxId(inputIdx + 1);
        const prevInputId = this.getBoxId(inputIdx - 1);
        const currentInputId = this.getBoxId(inputIdx);
        if (KeyboardUtil.ifRightArrow($event)) {
            $event.preventDefault();
            this.setSelected(nextInputId);
            return;
        }
        if (KeyboardUtil.ifLeftArrow($event)) {
            $event.preventDefault();
            this.setSelected(prevInputId);
            return;
        }
        if (KeyboardUtil.ifDelete($event)) {
            if (!$event.target.value) {
                this.clearInput(prevInputId, inputIdx - 1);
                this.setSelected(prevInputId);
            }
            else {
                this.clearInput(currentInputId, inputIdx);
            }
            this.rebuildValue();
            return;
        }
        if (!$event.target.value) {
            return;
        }
        if (this.ifValidKeyCode($event)) {
            this.setSelected(nextInputId);
        }
        this.rebuildValue();
    }
    validateNumber(val) {
        return val && /^\d*\.?\d*$/.test(val);
    }
    getBoxId(idx) {
        return `otp_${idx}_${this.componentKey}`;
    }
    clearInput(eleId, inputIdx) {
        let ctrlName = this.getControlName(inputIdx);
        this.otpForm.controls[ctrlName]?.setValue(null);
        const ele = document.getElementById(eleId);
        if (ele && ele instanceof HTMLInputElement) {
            ele.value = null;
        }
    }
    setSelected(eleId) {
        this.focusTo(eleId);
        const ele = document.getElementById(eleId);
        if (ele && ele.setSelectionRange) {
            setTimeout(() => {
                ele.setSelectionRange(0, 1);
            }, 0);
        }
    }
    ifValidKeyCode(event) {
        const inp = event.key;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        return (isMobile ||
            /[a-zA-Z0-9-_]/.test(inp));
    }
    focusTo(eleId) {
        const ele = document.getElementById(eleId);
        if (ele) {
            ele.focus();
        }
    }
    // method to set component value
    setValue(value) {
        if (this.config.allowNumbersOnly && isNaN(value)) {
            return;
        }
        this.otpForm.reset();
        if (!value) {
            this.rebuildValue();
            return;
        }
        value = value.toString().replace(/\s/g, ''); // remove whitespace
        Array.from(value).forEach((c, idx) => {
            if (this.otpForm.get(this.getControlName(idx))) {
                this.otpForm.get(this.getControlName(idx)).setValue(c);
            }
        });
        if (!this.config.disableAutoFocus) {
            const containerItem = document.getElementById(`c_${this.componentKey}`);
            var indexOfElementToFocus = value.length < this.config.length ? value.length : (this.config.length - 1);
            let ele = containerItem.getElementsByClassName('otp-input')[indexOfElementToFocus];
            if (ele && ele.focus) {
                ele.focus();
            }
        }
        this.rebuildValue();
    }
    rebuildValue() {
        let val = '';
        this.keysPipe.transform(this.otpForm.controls).forEach(k => {
            if (this.otpForm.controls[k].value) {
                let ctrlVal = this.otpForm.controls[k].value;
                let isLengthExceed = ctrlVal.length > 1;
                let isCaseTransformEnabled = !this.config.allowNumbersOnly && this.config.letterCase && (this.config.letterCase.toLocaleLowerCase() == 'upper' || this.config.letterCase.toLocaleLowerCase() == 'lower');
                ctrlVal = ctrlVal[0];
                let transformedVal = isCaseTransformEnabled ? this.config.letterCase.toLocaleLowerCase() == 'upper' ? ctrlVal.toUpperCase() : ctrlVal.toLowerCase() : ctrlVal;
                if (isCaseTransformEnabled && transformedVal == ctrlVal) {
                    isCaseTransformEnabled = false;
                }
                else {
                    ctrlVal = transformedVal;
                }
                val += ctrlVal;
                if (isLengthExceed || isCaseTransformEnabled) {
                    this.otpForm.controls[k].setValue(ctrlVal);
                }
            }
        });
        if (this.formCtrl?.setValue) {
            this.formCtrl.setValue(val);
        }
        this.onInputChange.emit(val);
        this.currentVal = val;
    }
    handlePaste(e) {
        // Get pasted data via clipboard API
        let clipboardData = e.clipboardData || window['clipboardData'];
        if (clipboardData) {
            var pastedData = clipboardData.getData('Text');
        }
        // Stop data actually being pasted into div
        e.stopPropagation();
        e.preventDefault();
        if (!pastedData || (this.config.allowNumbersOnly && !this.validateNumber(pastedData))) {
            return;
        }
        this.setValue(pastedData);
    }
}
/** @nocollapse */ NgOtpInputComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: NgOtpInputComponent, deps: [{ token: i1.KeysPipe }], target: i0.ɵɵFactoryTarget.Component });
/** @nocollapse */ NgOtpInputComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.3.12", type: NgOtpInputComponent, selector: "ng-otp-input", inputs: { config: "config", formCtrl: "formCtrl" }, outputs: { onInputChange: "onInputChange" }, ngImport: i0, template: "<div class=\"ng-otp-input-wrapper wrapper {{config.containerClass}}\" id=\"c_{{componentKey}}\" *ngIf=\"otpForm?.controls\"\r\n  [ngStyle]=\"config.containerStyles\">\r\n  <input (paste)=\"handlePaste($event)\" [pattern]=\"config.allowNumbersOnly ? '\\\\d*' : ''\" [type]=\"inputType\"  [placeholder]=\"config?.placeholder || ''\"\r\n    [ngStyle]=\"config.inputStyles\" \r\n    class=\"otp-input {{config.inputClass}}\" autocomplete=\"one-time-code\" *ngFor=\"let item of otpForm?.controls | keys;let i=index\"\r\n    [formControl]=\"otpForm.controls[item]\" #inp [id]=\"getBoxId(i)\" \r\n    (keyup)=\"onKeyUp($event,i)\" (input)=\"onInput($event)\" (keydown)=\"onKeyDown($event,i)\" >\r\n</div>", styles: [".otp-input{width:50px;height:50px;border-radius:4px;border:solid 1px #c5c5c5;text-align:center;font-size:32px}.ng-otp-input-wrapper .otp-input:not(:last-child){margin-right:8px}@media screen and (max-width: 767px){.otp-input{width:40px;font-size:24px;height:40px}}@media screen and (max-width: 420px){.otp-input{width:30px;font-size:18px;height:30px}}\n"], directives: [{ type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i2.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { type: i3.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { type: i3.PatternValidator, selector: "[pattern][formControlName],[pattern][formControl],[pattern][ngModel]", inputs: ["pattern"] }, { type: i3.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { type: i3.FormControlDirective, selector: "[formControl]", inputs: ["formControl", "disabled", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }], pipes: { "keys": i1.KeysPipe } });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.3.12", ngImport: i0, type: NgOtpInputComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ng-otp-input', template: "<div class=\"ng-otp-input-wrapper wrapper {{config.containerClass}}\" id=\"c_{{componentKey}}\" *ngIf=\"otpForm?.controls\"\r\n  [ngStyle]=\"config.containerStyles\">\r\n  <input (paste)=\"handlePaste($event)\" [pattern]=\"config.allowNumbersOnly ? '\\\\d*' : ''\" [type]=\"inputType\"  [placeholder]=\"config?.placeholder || ''\"\r\n    [ngStyle]=\"config.inputStyles\" \r\n    class=\"otp-input {{config.inputClass}}\" autocomplete=\"one-time-code\" *ngFor=\"let item of otpForm?.controls | keys;let i=index\"\r\n    [formControl]=\"otpForm.controls[item]\" #inp [id]=\"getBoxId(i)\" \r\n    (keyup)=\"onKeyUp($event,i)\" (input)=\"onInput($event)\" (keydown)=\"onKeyDown($event,i)\" >\r\n</div>", styles: [".otp-input{width:50px;height:50px;border-radius:4px;border:solid 1px #c5c5c5;text-align:center;font-size:32px}.ng-otp-input-wrapper .otp-input:not(:last-child){margin-right:8px}@media screen and (max-width: 767px){.otp-input{width:40px;font-size:24px;height:40px}}@media screen and (max-width: 420px){.otp-input{width:30px;font-size:18px;height:30px}}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.KeysPipe }]; }, propDecorators: { config: [{
                type: Input
            }], onInputChange: [{
                type: Output
            }], formCtrl: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctb3RwLWlucHV0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nLW90cC1pbnB1dC9zcmMvbGliL2NvbXBvbmVudHMvbmctb3RwLWlucHV0L25nLW90cC1pbnB1dC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZy1vdHAtaW5wdXQvc3JjL2xpYi9jb21wb25lbnRzL25nLW90cC1pbnB1dC9uZy1vdHAtaW5wdXQuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFFVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksRUFFYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7Ozs7QUFPekQsTUFBTSxPQUFPLG1CQUFtQjtJQW1COUIsWUFBb0IsUUFBa0I7UUFBbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQWxCN0IsV0FBTSxHQUFXLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDO1FBQ3hDLGdEQUFnRDtRQUN0QyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFJckQsa0JBQWEsR0FBa0IsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3RCxpQkFBWSxHQUNWLElBQUksQ0FBQyxNQUFNLEVBQUU7YUFDVixRQUFRLENBQUMsRUFBRSxDQUFDO2FBQ1osU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBUWIsQ0FBQztJQVAxQyxJQUFJLFNBQVM7UUFDWCxPQUFPLElBQUksQ0FB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QUFDO0lBQzVCLENBQUM7O29JQTFPVSxtQkFBbUI7d0hBQW5CLG1CQUFtQixxSkNsQmhDLDJyQkFPTTs0RkRXTyxtQkFBbUI7a0JBTi9CLFNBQVM7K0JBRUUsY0FBYzsrRkFLZixNQUFNO3NCQUFkLEtBQUs7Z0JBRUksYUFBYTtzQkFBdEIsTUFBTTtnQkFDRSxRQUFRO3NCQUFoQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBDb21wb25lbnQsXHJcbiAgT25Jbml0LFxyXG4gIElucHV0LFxyXG4gIE91dHB1dCxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgQWZ0ZXJWaWV3SW5pdFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGb3JtR3JvdXAsIEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBLZXlzUGlwZSB9IGZyb20gJy4uLy4uL3BpcGVzL2tleXMucGlwZSc7XHJcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJy4uLy4uL21vZGVscy9jb25maWcnO1xyXG5pbXBvcnQgeyBLZXlib2FyZFV0aWwgfSBmcm9tICcuLi8uLi91dGlscy9rZXlib2FyZC11dGlsJztcclxuQENvbXBvbmVudCh7XHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBjb21wb25lbnQtc2VsZWN0b3JcclxuICBzZWxlY3RvcjogJ25nLW90cC1pbnB1dCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL25nLW90cC1pbnB1dC5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vbmctb3RwLWlucHV0LmNvbXBvbmVudC5zY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIE5nT3RwSW5wdXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQge1xyXG4gIEBJbnB1dCgpIGNvbmZpZzogQ29uZmlnID0geyBsZW5ndGg6IDQgfTtcclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLW91dHB1dC1vbi1wcmVmaXhcclxuICBAT3V0cHV0KCkgb25JbnB1dENoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG4gIEBJbnB1dCgpIGZvcm1DdHJsOkZvcm1Db250cm9sO1xyXG4gIG90cEZvcm06IEZvcm1Hcm91cDtcclxuICBjdXJyZW50VmFsOnN0cmluZztcclxuICBpbnB1dENvbnRyb2xzOiBGb3JtQ29udHJvbFtdID0gbmV3IEFycmF5KHRoaXMuY29uZmlnLmxlbmd0aCk7XHJcbiAgY29tcG9uZW50S2V5ID1cclxuICAgIE1hdGgucmFuZG9tKClcclxuICAgICAgLnRvU3RyaW5nKDM2KVxyXG4gICAgICAuc3Vic3RyaW5nKDIpICsgbmV3IERhdGUoKS5nZXRUaW1lKCkudG9TdHJpbmcoMzYpO1xyXG4gIGdldCBpbnB1dFR5cGUoKXtcclxuICAgIHJldHVybiB0aGlzLmNvbmZpZz8uaXNQYXNzd29yZElucHV0IFxyXG4gICAgPyAncGFzc3dvcmQnIFxyXG4gICAgOiB0aGlzLmNvbmZpZz8uYWxsb3dOdW1iZXJzT25seSBcclxuICAgICAgPyAndGVsJ1xyXG4gICAgICA6ICd0ZXh0JztcclxuICB9XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBrZXlzUGlwZTogS2V5c1BpcGUpIHt9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5vdHBGb3JtID0gbmV3IEZvcm1Hcm91cCh7fSk7XHJcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgdGhpcy5jb25maWcubGVuZ3RoOyBpbmRleCsrKSB7XHJcbiAgICAgIHRoaXMub3RwRm9ybS5hZGRDb250cm9sKHRoaXMuZ2V0Q29udHJvbE5hbWUoaW5kZXgpLCBuZXcgRm9ybUNvbnRyb2woKSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLm90cEZvcm0udmFsdWVDaGFuZ2VzLnN1YnNjcmliZSgodjpvYmplY3QpPT57XHJcbiAgICAgIHRoaXMua2V5c1BpcGUudHJhbnNmb3JtKHRoaXMub3RwRm9ybS5jb250cm9scykuZm9yRWFjaCgoaykgPT4ge1xyXG4gICAgICAgIHZhciB2YWwgPSB0aGlzLm90cEZvcm0uY29udHJvbHNba10udmFsdWU7XHJcbiAgICAgICAgaWYodmFsICYmIHZhbC5sZW5ndGg+MSl7XHJcbiAgICAgICAgICBpZiAodmFsLmxlbmd0aCA+PSB0aGlzLmNvbmZpZy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZSh2YWwpO1xyXG4gICAgICAgICAgfWVsc2V7XHJcbiAgICAgICAgICAgIHRoaXMucmVidWlsZFZhbHVlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmNvbmZpZy5kaXNhYmxlQXV0b0ZvY3VzKSB7XHJcbiAgICAgIGNvbnN0IGNvbnRhaW5lckl0ZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChgY18ke3RoaXMuY29tcG9uZW50S2V5fWApO1xyXG4gICAgICBpZiAoY29udGFpbmVySXRlbSkge1xyXG4gICAgICAgIGNvbnN0IGVsZTogYW55ID0gY29udGFpbmVySXRlbS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdvdHAtaW5wdXQnKVswXTtcclxuICAgICAgICBpZiAoZWxlICYmIGVsZS5mb2N1cykge1xyXG4gICAgICAgICAgZWxlLmZvY3VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0Q29udHJvbE5hbWUoaWR4KSB7XHJcbiAgICByZXR1cm4gYGN0cmxfJHtpZHh9YDtcclxuICB9XHJcblxyXG4gIG9uS2V5RG93bigkZXZlbnQsIGlucHV0SWR4KXtcclxuICAgIGNvbnN0IHByZXZJbnB1dElkID0gdGhpcy5nZXRCb3hJZChpbnB1dElkeCAtIDEpO1xyXG4gICAgY29uc3QgY3VycmVudElucHV0SWQgPSB0aGlzLmdldEJveElkKGlucHV0SWR4KTtcclxuICAgIGlmIChLZXlib2FyZFV0aWwuaWZTcGFjZWJhcigkZXZlbnQpKSB7XHJcbiAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgfVxyXG4gICAgIGlmIChLZXlib2FyZFV0aWwuaWZCYWNrc3BhY2UoJGV2ZW50KSkge1xyXG4gICAgICBpZighJGV2ZW50LnRhcmdldC52YWx1ZSl7XHJcbiAgICAgICAgdGhpcy5jbGVhcklucHV0KHByZXZJbnB1dElkLGlucHV0SWR4LTEpO1xyXG4gICAgICAgIHRoaXMuc2V0U2VsZWN0ZWQocHJldklucHV0SWQpO1xyXG4gICAgICB9ZWxzZXtcclxuICAgICAgICB0aGlzLmNsZWFySW5wdXQoY3VycmVudElucHV0SWQsaW5wdXRJZHgpO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucmVidWlsZFZhbHVlKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9XHJcbiAgb25JbnB1dCgkZXZlbnQpe1xyXG4gICAgbGV0IG5ld1ZhbD10aGlzLmN1cnJlbnRWYWwgPyBgJHt0aGlzLmN1cnJlbnRWYWx9JHskZXZlbnQudGFyZ2V0LnZhbHVlfWAgOiAkZXZlbnQudGFyZ2V0LnZhbHVlO1xyXG4gICAgaWYodGhpcy5jb25maWcuYWxsb3dOdW1iZXJzT25seSAmJiAhdGhpcy52YWxpZGF0ZU51bWJlcihuZXdWYWwpKXtcclxuICAgICAgJGV2ZW50LnRhcmdldC52YWx1ZT0nJztcclxuICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIH1cclxuICBcclxuXHJcbiAgb25LZXlVcCgkZXZlbnQsIGlucHV0SWR4KSB7XHJcbiAgICBpZihLZXlib2FyZFV0aWwuaWZUYWIoJGV2ZW50KSl7XHJcbiAgICAgIGlucHV0SWR4LT0xO1xyXG4gICAgfVxyXG4gICAgY29uc3QgbmV4dElucHV0SWQgPSB0aGlzLmdldEJveElkKGlucHV0SWR4ICsgMSk7XHJcbiAgICBjb25zdCBwcmV2SW5wdXRJZCA9IHRoaXMuZ2V0Qm94SWQoaW5wdXRJZHggLSAxKTtcclxuICAgIGNvbnN0IGN1cnJlbnRJbnB1dElkID0gdGhpcy5nZXRCb3hJZChpbnB1dElkeCk7XHJcbiAgICBpZiAoS2V5Ym9hcmRVdGlsLmlmUmlnaHRBcnJvdygkZXZlbnQpKSB7XHJcbiAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICB0aGlzLnNldFNlbGVjdGVkKG5leHRJbnB1dElkKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKEtleWJvYXJkVXRpbC5pZkxlZnRBcnJvdygkZXZlbnQpKSB7XHJcbiAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICB0aGlzLnNldFNlbGVjdGVkKHByZXZJbnB1dElkKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKEtleWJvYXJkVXRpbC5pZkRlbGV0ZSgkZXZlbnQpKSB7XHJcbiAgICAgIGlmKCEkZXZlbnQudGFyZ2V0LnZhbHVlKXtcclxuICAgICAgICB0aGlzLmNsZWFySW5wdXQocHJldklucHV0SWQsaW5wdXRJZHgtMSk7XHJcbiAgICAgICAgdGhpcy5zZXRTZWxlY3RlZChwcmV2SW5wdXRJZCk7XHJcbiAgICAgIH1lbHNle1xyXG4gICAgICAgIHRoaXMuY2xlYXJJbnB1dChjdXJyZW50SW5wdXRJZCxpbnB1dElkeCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5yZWJ1aWxkVmFsdWUoKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBpZiAoISRldmVudC50YXJnZXQudmFsdWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gIFxyXG4gICAgaWYgKHRoaXMuaWZWYWxpZEtleUNvZGUoJGV2ZW50KSkge1xyXG4gICAgICB0aGlzLnNldFNlbGVjdGVkKG5leHRJbnB1dElkKTtcclxuICAgIH1cclxuICAgIHRoaXMucmVidWlsZFZhbHVlKCk7XHJcbiAgfVxyXG5cclxuICB2YWxpZGF0ZU51bWJlcih2YWwpe1xyXG4gICAgcmV0dXJuIHZhbCAmJiAvXlxcZCpcXC4/XFxkKiQvLnRlc3QodmFsKTtcclxuICB9XHJcblxyXG4gIGdldEJveElkKGlkeDpzdHJpbmcgfCBudW1iZXIpe1xyXG4gICAgcmV0dXJuIGBvdHBfJHtpZHh9XyR7dGhpcy5jb21wb25lbnRLZXl9YDtcclxuICB9XHJcblxyXG4gcHJpdmF0ZSBjbGVhcklucHV0KGVsZUlkOnN0cmluZyxpbnB1dElkeCl7XHJcbiAgICBsZXQgY3RybE5hbWU9dGhpcy5nZXRDb250cm9sTmFtZShpbnB1dElkeCk7XHJcbiAgICB0aGlzLm90cEZvcm0uY29udHJvbHNbY3RybE5hbWVdPy5zZXRWYWx1ZShudWxsKTtcclxuICAgIGNvbnN0IGVsZT1kb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVJZCk7XHJcbiAgICBpZihlbGUgJiYgZWxlIGluc3RhbmNlb2YgSFRNTElucHV0RWxlbWVudCl7XHJcbiAgICAgIGVsZS52YWx1ZT1udWxsO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiBwcml2YXRlIHNldFNlbGVjdGVkKGVsZUlkKSB7XHJcbiAgICB0aGlzLmZvY3VzVG8oZWxlSWQpO1xyXG4gICAgY29uc3QgZWxlOiBhbnkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlbGVJZCk7XHJcbiAgICBpZiAoZWxlICYmIGVsZS5zZXRTZWxlY3Rpb25SYW5nZSkge1xyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICBlbGUuc2V0U2VsZWN0aW9uUmFuZ2UoMCwgMSk7XHJcbiAgICAgIH0sIDApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiBwcml2YXRlIGlmVmFsaWRLZXlDb2RlKGV2ZW50KSB7XHJcbiAgICBjb25zdCBpbnAgPSBldmVudC5rZXk7XHJcbiAgICBjb25zdCBpc01vYmlsZSA9IC9pUGhvbmV8aVBhZHxpUG9kfEFuZHJvaWQvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpO1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgaXNNb2JpbGUgfHxcclxuICAgICAgL1thLXpBLVowLTktX10vLnRlc3QoaW5wKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGZvY3VzVG8oZWxlSWQpIHtcclxuICAgIGNvbnN0IGVsZTogYW55ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlSWQpO1xyXG4gICAgaWYgKGVsZSkge1xyXG4gICAgICBlbGUuZm9jdXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIG1ldGhvZCB0byBzZXQgY29tcG9uZW50IHZhbHVlXHJcbiAgc2V0VmFsdWUodmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHRoaXMuY29uZmlnLmFsbG93TnVtYmVyc09ubHkgJiYgaXNOYU4odmFsdWUpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5vdHBGb3JtLnJlc2V0KCk7XHJcbiAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgdGhpcy5yZWJ1aWxkVmFsdWUoKTtcclxuICAgICAgIHJldHVybjtcclxuICAgICB9XHJcbiAgICAgdmFsdWUgPSB2YWx1ZS50b1N0cmluZygpLnJlcGxhY2UoL1xccy9nLCAnJyk7IC8vIHJlbW92ZSB3aGl0ZXNwYWNlXHJcbiAgICAgQXJyYXkuZnJvbSh2YWx1ZSkuZm9yRWFjaCgoYywgaWR4KSA9PiB7XHJcbiAgICAgICAgICBpZiAodGhpcy5vdHBGb3JtLmdldCh0aGlzLmdldENvbnRyb2xOYW1lKGlkeCkpKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3RwRm9ybS5nZXQodGhpcy5nZXRDb250cm9sTmFtZShpZHgpKS5zZXRWYWx1ZShjKTtcclxuICAgICAgICAgIH1cclxuICAgICB9KTtcclxuICAgICBpZiAoIXRoaXMuY29uZmlnLmRpc2FibGVBdXRvRm9jdXMpIHtcclxuICAgICAgY29uc3QgY29udGFpbmVySXRlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGBjXyR7dGhpcy5jb21wb25lbnRLZXl9YCk7XHJcbiAgICAgIHZhciBpbmRleE9mRWxlbWVudFRvRm9jdXMgPSB2YWx1ZS5sZW5ndGggPCB0aGlzLmNvbmZpZy5sZW5ndGggPyB2YWx1ZS5sZW5ndGggOiAodGhpcy5jb25maWcubGVuZ3RoIC0gMSk7XHJcbiAgICAgIGxldCBlbGUgOiBhbnkgPSBjb250YWluZXJJdGVtLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ290cC1pbnB1dCcpW2luZGV4T2ZFbGVtZW50VG9Gb2N1c107XHJcbiAgICAgIGlmIChlbGUgJiYgZWxlLmZvY3VzKSB7XHJcbiAgICAgICAgZWxlLmZvY3VzKCk7XHJcbiAgICAgIH1cclxuICAgICB9XHJcbiAgICAgdGhpcy5yZWJ1aWxkVmFsdWUoKTtcclxuICB9XHJcblxyXG5wcml2YXRlIHJlYnVpbGRWYWx1ZSgpIHtcclxuICAgIGxldCB2YWwgPSAnJztcclxuICAgIHRoaXMua2V5c1BpcGUudHJhbnNmb3JtKHRoaXMub3RwRm9ybS5jb250cm9scykuZm9yRWFjaChrID0+IHtcclxuICAgICAgaWYgKHRoaXMub3RwRm9ybS5jb250cm9sc1trXS52YWx1ZSkge1xyXG4gICAgICAgIGxldCBjdHJsVmFsPXRoaXMub3RwRm9ybS5jb250cm9sc1trXS52YWx1ZTtcclxuICAgICAgICBsZXQgaXNMZW5ndGhFeGNlZWQ9Y3RybFZhbC5sZW5ndGg+MTtcclxuICAgICAgICBsZXQgaXNDYXNlVHJhbnNmb3JtRW5hYmxlZD0gIXRoaXMuY29uZmlnLmFsbG93TnVtYmVyc09ubHkgJiYgdGhpcy5jb25maWcubGV0dGVyQ2FzZSAmJiAodGhpcy5jb25maWcubGV0dGVyQ2FzZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09ICd1cHBlcicgfHwgdGhpcy5jb25maWcubGV0dGVyQ2FzZS50b0xvY2FsZUxvd2VyQ2FzZSgpPT0gJ2xvd2VyJyk7XHJcbiAgICAgICAgY3RybFZhbD1jdHJsVmFsWzBdO1xyXG4gICAgICAgIGxldCB0cmFuc2Zvcm1lZFZhbD1pc0Nhc2VUcmFuc2Zvcm1FbmFibGVkID8gdGhpcy5jb25maWcubGV0dGVyQ2FzZS50b0xvY2FsZUxvd2VyQ2FzZSgpID09ICd1cHBlcicgPyBjdHJsVmFsLnRvVXBwZXJDYXNlKCkgOiBjdHJsVmFsLnRvTG93ZXJDYXNlKCkgIDogY3RybFZhbDtcclxuICAgICAgICBpZihpc0Nhc2VUcmFuc2Zvcm1FbmFibGVkICYmIHRyYW5zZm9ybWVkVmFsID09IGN0cmxWYWwpe1xyXG4gICAgICAgICAgaXNDYXNlVHJhbnNmb3JtRW5hYmxlZD1mYWxzZTtcclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgIGN0cmxWYWw9dHJhbnNmb3JtZWRWYWw7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhbCArPSBjdHJsVmFsO1xyXG4gICAgICAgIGlmKGlzTGVuZ3RoRXhjZWVkIHx8IGlzQ2FzZVRyYW5zZm9ybUVuYWJsZWQpIFxyXG4gICAgICAgIHtcclxuICAgICAgICAgdGhpcy5vdHBGb3JtLmNvbnRyb2xzW2tdLnNldFZhbHVlKGN0cmxWYWwpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICBpZih0aGlzLmZvcm1DdHJsPy5zZXRWYWx1ZSl7XHJcbiAgICAgIHRoaXMuZm9ybUN0cmwuc2V0VmFsdWUodmFsKTtcclxuICAgIH1cclxuICAgIHRoaXMub25JbnB1dENoYW5nZS5lbWl0KHZhbCk7XHJcbiAgICB0aGlzLmN1cnJlbnRWYWw9dmFsO1xyXG4gIH1cclxuICBcclxuICBcclxuICBoYW5kbGVQYXN0ZShlKSB7XHJcbiAgICAvLyBHZXQgcGFzdGVkIGRhdGEgdmlhIGNsaXBib2FyZCBBUElcclxuICAgIGxldCBjbGlwYm9hcmREYXRhID0gZS5jbGlwYm9hcmREYXRhIHx8IHdpbmRvd1snY2xpcGJvYXJkRGF0YSddO1xyXG4gICAgaWYoY2xpcGJvYXJkRGF0YSl7XHJcbiAgICAgdmFyIHBhc3RlZERhdGEgPWNsaXBib2FyZERhdGEuZ2V0RGF0YSgnVGV4dCcpO1xyXG4gICAgfVxyXG4gICAgLy8gU3RvcCBkYXRhIGFjdHVhbGx5IGJlaW5nIHBhc3RlZCBpbnRvIGRpdlxyXG4gICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgIGlmICghcGFzdGVkRGF0YSB8fCAodGhpcy5jb25maWcuYWxsb3dOdW1iZXJzT25seSAmJiAhdGhpcy52YWxpZGF0ZU51bWJlcihwYXN0ZWREYXRhKSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5zZXRWYWx1ZShwYXN0ZWREYXRhKTtcclxuICB9XHJcbn1cclxuIiwiPGRpdiBjbGFzcz1cIm5nLW90cC1pbnB1dC13cmFwcGVyIHdyYXBwZXIge3tjb25maWcuY29udGFpbmVyQ2xhc3N9fVwiIGlkPVwiY197e2NvbXBvbmVudEtleX19XCIgKm5nSWY9XCJvdHBGb3JtPy5jb250cm9sc1wiXHJcbiAgW25nU3R5bGVdPVwiY29uZmlnLmNvbnRhaW5lclN0eWxlc1wiPlxyXG4gIDxpbnB1dCAocGFzdGUpPVwiaGFuZGxlUGFzdGUoJGV2ZW50KVwiIFtwYXR0ZXJuXT1cImNvbmZpZy5hbGxvd051bWJlcnNPbmx5ID8gJ1xcXFxkKicgOiAnJ1wiIFt0eXBlXT1cImlucHV0VHlwZVwiICBbcGxhY2Vob2xkZXJdPVwiY29uZmlnPy5wbGFjZWhvbGRlciB8fCAnJ1wiXHJcbiAgICBbbmdTdHlsZV09XCJjb25maWcuaW5wdXRTdHlsZXNcIiBcclxuICAgIGNsYXNzPVwib3RwLWlucHV0IHt7Y29uZmlnLmlucHV0Q2xhc3N9fVwiIGF1dG9jb21wbGV0ZT1cIm9uZS10aW1lLWNvZGVcIiAqbmdGb3I9XCJsZXQgaXRlbSBvZiBvdHBGb3JtPy5jb250cm9scyB8IGtleXM7bGV0IGk9aW5kZXhcIlxyXG4gICAgW2Zvcm1Db250cm9sXT1cIm90cEZvcm0uY29udHJvbHNbaXRlbV1cIiAjaW5wIFtpZF09XCJnZXRCb3hJZChpKVwiIFxyXG4gICAgKGtleXVwKT1cIm9uS2V5VXAoJGV2ZW50LGkpXCIgKGlucHV0KT1cIm9uSW5wdXQoJGV2ZW50KVwiIChrZXlkb3duKT1cIm9uS2V5RG93bigkZXZlbnQsaSlcIiA+XHJcbjwvZGl2PiJdfQ==